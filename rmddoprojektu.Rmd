---
title: "Projekt"
output: html_document
date: "2025-01-31"
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Projekt analiza danych samochod√≥w

# **Struktura pracy** üìù

## [1 Data Cleansing & Data Wrangling]{.underline}

### 1.1 Wczytanie danych

Wczytujemy plik z surowymi danymi samochody_new.csv [Kliknij, aby pobraƒá plik](data/samochody_new.csv)

### 1.2 Usuniƒôcie brakujƒÖcych warto≈õci

Badamy i usuwamy brakujƒÖce warto≈õci w danych, u≈ºywamy do tego pakiet√≥w (tidyverse) i (naniar).

```{r, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(naniar)
# Wczytanie pliku CSV
samochody_new <- read_csv("samochody_new.csv")

# PodglƒÖd danych
head(samochody_new)
```

```{r}
library(naniar)
library(ggplot2)
library(dplyr)
#Brakujace obserwacje
n_miss(samochody_new) #liczba brakujacych danych
n_complete(samochody_new) #liczba kompletynch obserwacji
prop_miss(samochody_new) #proporcja
# Sprawdzanie brakujƒÖcych warto≈õci
samochody_new %>% 
  miss_case_table()

# Wizualizacja brak√≥w danych

#Wizualizacja brakujacych obserwacji
vis_miss(samochody_new, warn_large_data = FALSE)
#wizualizacja brakujacych danych
gg_miss_fct(samochody_new, fct = gearbox) 
#brakujace dane ze wzgledu na typ skrzyni biegow
gg_miss_upset(samochody_new, 
              nsets = 10)
```

### 1.3 Poprawa formatowania i eliminacja ocena brakujƒÖcych

```{r, include=FALSE}
library(readr)
library(naniar)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(dlookr)
library(editrules)
library(VIM)
library(deducorrect)
library(ISLR)
#Zastapienie innych wartosci specjalnych na NA
is.special <- function(x){
  if (is.numeric(x)) !is.finite(x) else is.na(x)
}

sapply(samochody_new, is.special)
#Dodanie warunkow do danych
unique(samochody_new$gearbox)
RULE <- editset(c("year >= 1900","gearbox %in% c('manual','automatic')"
                  , "price_in_pln > 0"))
violated <- violatedEdits(RULE, samochody_new)
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
library(readr)
library(visdat)

# Funkcja do zamiany danych w kolumnach year i engine_capacity
fix_year_and_engine_capacity <- function(data) {
  invalid_year <- grepl("cm3$", data$year)
  data$engine_capacity[invalid_year] <- data$year[invalid_year]
  data$year[invalid_year] <- NA
  invalid_engine_capacity <- grepl("^[1-2][0-9]{3}$", data$engine_capacity) & 
      as.numeric(data$engine_capacity) > 1900
  data$year[invalid_engine_capacity] <- data$engine_capacity[invalid_engine_capacity]
  data$engine_capacity[invalid_engine_capacity] <- NA
  return(data)
}

# Zastosuj funkcjƒô do swojego zbioru danych
samochody_new <- fix_year_and_engine_capacity(samochody_new)

# Funkcja do zamiany danych w kolumnach year i fuel_type
fix_year_and_fuel_type <- function(data) {
  fuel_types <- c("Elektryczny", "Benzyna", "Diesel", "Hybryda", "Benzyna+LPG")
  invalid_year <- data$year %in% fuel_types
  data$fuel_type[invalid_year] <- data$year[invalid_year]
  data$year[invalid_year] <- NA
  invalid_fuel_type <- grepl("^[1-2][0-9]{3}$", data$fuel_type) & 
      as.numeric(data$fuel_type) > 1900
  data$year[invalid_fuel_type] <- data$fuel_type[invalid_fuel_type]
  data$fuel_type[invalid_fuel_type] <- NA
  return(data)
}

# Zastosuj funkcjƒô do swojego zbioru danych
samochody_new <- fix_year_and_fuel_type(samochody_new)

# Funkcja do zamiany danych w kolumnach fuel_type i mileage
fix_fuel_type_and_mileage <- function(data) {
  invalid_fuel_type <- grepl("km$", data$fuel_type)
  data$mileage[invalid_fuel_type] <- data$fuel_type[invalid_fuel_type]
  data$fuel_type[invalid_fuel_type] <- NA
  fuel_types <- c("Elektryczny", "Benzyna", "Diesel", "Hybryda", "Benzyna+LPG")
  invalid_mileage <- data$mileage %in% fuel_types
  data$fuel_type[invalid_mileage] <- data$mileage[invalid_mileage]
  data$mileage[invalid_mileage] <- NA
  return(data)
}

# Zastosuj funkcjƒô do swojego zbioru danych
samochody_new <- fix_fuel_type_and_mileage(samochody_new)

# Funkcja do zamiany danych w kolumnach year i mileage
fix_year_and_mileage <- function(data) {
  invalid_year <- grepl("km$", data$year)
  data$mileage[invalid_year] <- data$year[invalid_year]
  data$year[invalid_year] <- NA
  invalid_mileage <- grepl("^[1-2][0-9]{3}$", data$mileage) & 
      as.numeric(data$mileage) > 1900
  data$year[invalid_mileage] <- data$mileage[invalid_mileage]
  data$mileage[invalid_mileage] <- NA
  return(data)
}

# Zastosuj funkcjƒô do swojego zbioru danych
samochody_new <- fix_year_and_mileage(samochody_new)

# Zapisz zmodyfikowane dane do pliku
write.csv(samochody_new, "pozmianach1.csv", row.names = FALSE)

# Wczytanie danych po zmianach
samochody_01 <- read_csv("pozmianach1.csv")

# Wizualizacja brakujƒÖcych danych
vis_miss(samochody_01, warn_large_data = FALSE)
```

### 1.4 Imputowanie warto≈õci dla brakujƒÖcych lub b≈Çƒôdnych danych

```{r, message=FALSE, warning=FALSE, include=FALSE}
#Biblioteki
library(readr)
library(naniar)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(dlookr)
library(editrules)
library(VIM)
library(deducorrect)
library(ISLR) 
library(hot.deck)
library(mice)
```

```{r,message=FALSE, warning=FALSE}
#Imputacja brak√≥w danych za pomocƒÖ funkcji mice 
imputed_data <- mice(samochody_01, method = "pmm", m = 5, maxit = 10, seed = 123)

# Pobranie pierwszego uzupe≈Çnionego zbioru danych
samochody_01_imputed <- complete(imputed_data, 1)

# Nadpisanie kolumny year w oryginalnym zbiorze
samochody_01$year <- samochody_01_imputed$year 

# Sprawdzenie czy braki zosta≈Çy uzupe≈Çnione
vis_miss(samochody_01, warn_large_data = FALSE)

# ZastƒÖpienie NA w kolumnie fuel_type
samochody_01$fuel_type <- ifelse(
  is.na(samochody_01$fuel_type) & samochody_01$engine_capacity == "Elektryczny",
  "Elektryczny",
  samochody_01$fuel_type
)
# efekty zastƒÖpienia NA w elektrycznych autach
vis_miss(samochody_01, warn_large_data = FALSE)
# eliminowanie NA w hybrydach
samochody_01$fuel_type <- ifelse(
  is.na(samochody_01$fuel_type) & samochody_01$engine_capacity == "Hybryda",
  "Hybryda",
  samochody_01$fuel_type
)
vis_miss(samochody_01, warn_large_data = FALSE)


samochody_01$engine_capacity <- trimws(tolower(samochody_01$engine_capacity))

# ZastƒÖpienie brak√≥w w fuel_type
samochody_01$fuel_type <- ifelse(
  is.na(samochody_01$fuel_type) & samochody_01$engine_capacity == "elektryczny",
  "Elektryczne",
  samochody_01$fuel_type
)
table(is.na(samochody_01$fuel_type))
##
# Wyodrƒôbnienie kolumn fuel_type i brand
samochody_fuel_brand <- samochody_01[, c("fuel_type", "brand"), drop = FALSE]
```

```{r, include=FALSE}
# Imputacja tylko dla kolumn fuel_type i brand
imputed_data <- mice(samochody_fuel_brand, method = c("polyreg", "polyreg"), m = 5, maxit = 10, seed = 123)
```

```{r}
# Uzyskanie pierwszej imputacji
fuel_brand_imputed <- complete(imputed_data, 1)

# Zaktualizowanie oryginalnych kolumn fuel_type i brand w samochody_01
samochody_01$fuel_type <- fuel_brand_imputed$fuel_type
samochody_01$brand <- fuel_brand_imputed$brand

vis_miss(samochody_01, warn_large_data = FALSE)
```

## 1.5 Oczyszcenie danych z dalszych brakujƒÖcych warto≈õci

```{r}
# Usuniƒôcie wierszy z NA w kolumnie 'fuel_type'
samochody_01_cleaned <- samochody_01[!is.na(samochody_01$fuel_type), ]

# Wy≈õwietlenie oczyszczonej ramki danych
print(samochody_01_cleaned)
vis_miss(samochody_01_cleaned, warn_large_data = FALSE)

#decyzja o usuniƒôciu obserwacji z NA 
samochody_dowiz <- samochody_01[complete.cases(samochody_01), ]
```

Wynikiem jest poni≈ºsza tabela z danymi po oczyszczeniu z brakujƒÖcych warto≈õci:

```{r,echo=FALSE}
print(samochody_dowiz)
vis_miss(samochody_dowiz, warn_large_data = FALSE)
```

Mo≈ºemy zauwa≈ºyc kompletnosc danych po oczyszczeniu z brakujƒÖcych warto≈õci

##2 Wizualizacja danych ##3 Analiza opisowa

## [4 Wnioskowanie statystyczne]{style="color:green"}

```{r, include=FALSE}
library(ggstatsplot)
library(ggplot2)
```

W tym rozdziale przeprowadzona zosta≈Ça analiza statystyczna, majƒÖca na celu identyfikacjƒô zale≈ºno≈õci miƒôdzy r√≥≈ºnymi cechami samochod√≥w a ich cenƒÖ.
Wykorzystano do tego r√≥≈ºne testy statystyczne i metody wizualizacji danych z pakietu ggstatsplot.

\###[***1.Histogram cen samochod√≥w i test normalno≈õci***]{.underline}

üìåRozk≈Çad cen samochod√≥w nie jest normalny ‚Äì jest prawostronnie asymetryczny (du≈ºa liczba ta≈Ñszych aut, kilka bardzo drogich).
üìå Nie mo≈ºna stosowaƒá test√≥w parametrycznych opartych na rozk≈Çadzie normalnym.
üìå Przedzia≈Ç ufno≈õci dla ≈õredniej ceny samochodu wynosi od 75 931 PLN do 77 270 PLN (95% pewno≈õci).

üìä Wizualizacja: Histogram cen samochod√≥w, pokazujƒÖcy asymetriƒô w rozk≈Çadzie.

```{r, message=FALSE, warning=FALSE}
gghistostats(
  data = dane,
  x = price_in_pln,
  title = "Histogram cen samochod√≥w z testem normalno≈õci",
  xlab = "Cena (PLN)",
  test.value = 0,
  type = "parametric"
) +
  scale_x_continuous(
    limits = c(0, 1000000),
    breaks = seq(0, 1000000, by = 200000),  # Etykiety co 200k
    labels = scales::comma
  )

```

\###[***2.Por√≥wnanie cen samochod√≥w w zale≈ºno≈õci od rodzaju paliwa.***]{.underline}

Za pomocƒÖ testu F Welcha sprawdzono, czy r√≥≈ºnice w ≈õrednich cenach miƒôdzy samochodami elektrycznymi, benzynowymi, hybrydowymi i dieslami sƒÖ statystycznie istotne.

Wyniki wskazujƒÖ, ≈ºe: ‚úÖ IstniejƒÖ istotne r√≥≈ºnice cenowe miƒôdzy rodzajami paliwa (p \< 0.001).
‚úÖ Samochody elektryczne majƒÖ wyra≈∫nie wy≈ºsze ceny w por√≥wnaniu do innych typ√≥w paliwa.
‚úÖ Wsp√≥≈Çczynnik efektu (0.96) sugeruje, ≈ºe rodzaj paliwa silnie wp≈Çywa na cenƒô.
‚úÖ Bardzo du≈ºa liczba obserwacji (n = 83,625) sprawia, ≈ºe test jest bardzo wiarygodny

üìä Wizualizacja: Wykres pude≈Çkowy przedstawiajƒÖcy ≈õrednie ceny w zale≈ºno≈õci od rodzaju paliwa.

```{r, echo=FALSE}
ggbetweenstats(
  data = dane,
  x = fuel_type,
  y = price_in_pln,
  type = "parametric", 
  title = "Por√≥wnanie ≈õrednich cen samochod√≥w w zale≈ºno≈õci od rodzaju paliwa",
  xlab = "Rodzaj paliwa",
  ylab = "Cena (PLN)",
  messages = FALSE
)
```

\###[***3.Korelacja miƒôdzy przebiegiem a cenƒÖ samochodu***]{.underline}.

Badanie zwiƒÖzku miƒôdzy liczbƒÖ przejechanych kilometr√≥w, a cenƒÖ samochodu wykaza≈Ço:

```{r, echo=FALSE}
cor.test(dane$mileage, dane$price_in_pln, method = "spearman")
```

-Warto≈õƒá wsp√≥≈Çczynnika korelacji Spearmana wynosi -0.59.
To oznacza umiarkowanƒÖ negatywnƒÖ korelacjƒô miƒôdzy przebiegiem a cenƒÖ samochodu.
Im wiƒôkszy przebieg, tym ni≈ºsza cena samochodu.
-Jest to zgodne z intuicjƒÖ, poniewa≈º samochody z wiƒôkszym przebiegiem sƒÖ zazwyczaj starsze i mogƒÖ byƒá bardziej zu≈ºyte.

-Istotno≈õƒá statystyczna: Korelacja jest statystycznie istotna, wiƒôc mo≈ºemy z du≈ºƒÖ pewno≈õciƒÖ stwierdziƒá, ≈ºe ta zale≈ºno≈õƒá jest prawdziwa w populacji samochod√≥w.

```{r, echo=FALSE}
kruskal.test(price_in_pln ~ mileage, data = dane)
```

Wynik dla statystyka testu Kruskala-Wallisa 47625.
Jest to miara r√≥≈ºnic miƒôdzy grupami.
Warto≈õƒá 47625 wskazuje, ≈ºe r√≥≈ºnice miƒôdzy grupami (w tym przypadku cenami samochod√≥w w zale≈ºno≈õci od przebiegu) sƒÖ do≈õƒá du≈ºe.

Interpretacja: Hipoteza zerowa (H‚ÇÄ): Zak≈Çada, ≈ºe nie ma r√≥≈ºnic miƒôdzy grupami (w tym przypadku brak r√≥≈ºnic w cenach samochod√≥w w zale≈ºno≈õci od przebiegu).
Hipoteza alternatywna (H‚ÇÅ): Zak≈Çada, ≈ºe istniejƒÖ r√≥≈ºnice miƒôdzy grupami (w tym przypadku ceny samochod√≥w r√≥≈ºniƒÖ siƒô w zale≈ºno≈õci od przebiegu).
Poniewa≈º p-warto≈õƒá jest mniejsza ni≈º 0.05 (a konkretnie jest znacznie mniejsza), oznacza to, ≈ºe odrzucamy hipotezƒô zerowƒÖ.
W zwiƒÖzku z tym mo≈ºemy stwierdziƒá, ≈ºe istniejƒÖ statystycznie istotne r√≥≈ºnice w cenach samochod√≥w w zale≈ºno≈õci od przebiegu.

Wnioski: Test Kruskala-Wallisa wykazuje, ≈ºe ceny samochod√≥w r√≥≈ºniƒÖ siƒô w zale≈ºno≈õci od ich przebiegu.
Oznacza to,≈ºe w populacji samochod√≥w przebieg mo≈ºe mieƒá znaczenie dla kszta≈Çtowania ceny samochodu.
Warto tak≈ºe zauwa≈ºyƒá, ≈ºe test Kruskala-Wallisa jest testem nieparametrycznym, co oznacza, ≈ºe nie zak≈Çada on rozk≈Çadu normalnego danych.
Jest to dobry wyb√≥r, gdy dane majƒÖ rozk≈Çad nienormalny lub zawierajƒÖ warto≈õci odstajƒÖce.

üìä Wizualizacja: Wykres rozrzutu pokazujƒÖcy negatywnƒÖ zale≈ºno≈õƒá miƒôdzy przebiegiem a cenƒÖ.

```{r}
plot(dane$mileage, dane$price_in_pln,
     xlab = "Przebieg (km)",
     ylab = "Cena (PLN)",
     main = "Zale≈ºno≈õƒá miƒôdzy cenƒÖ a przebiegiem samochodu")
```

###4.[***Wp≈Çyw marki na cenƒô samochodu.***]{.underline}

Por√≥wnano ceny samochod√≥w piƒôciu najpopularniejszych marek, stosujƒÖc test Kruskala-Wallisa.
üîπ BMW i Mercedes-Benz sƒÖ najdro≈ºszymi markami.
üîπ Opel, Peugeot i Volkswagen majƒÖ znaczƒÖco ni≈ºsze ceny.
üîπ Test wykaza≈Ç istotne r√≥≈ºnice miƒôdzy markami (p \< 0.001).
üîπ Wykres wyra≈∫nie pokazuje, ≈ºe ≈õrednie ceny samochod√≥w r√≥≈ºniƒÖ siƒô w zale≈ºno≈õci od marki üìä Wizualizacja: Wykres przedstawiajƒÖcy medianowe ceny samochod√≥w r√≥≈ºnych marek.

```{r}
png("marka_a_cena.png", width = 1600, height = 1200, res = 300)

samochody_top_5_brands <- na.omit(samochody_top_5_brands)  # Usu≈Ñ brakujƒÖce dane

ggbetweenstats(
  data = samochody_top_5_brands,
  x = brand,
  y = price_in_pln,
  title = "zale≈ºno≈õƒá ceny od marki samochodu",
  xlab = "Marka",
  ylab = "Cena (PLN)",
  type = "np",
  pairwise.comparisons = TRUE,
  pairwise.display = "significant",
  centrality.param = "median",
  centrality.para.method = "nonparametric",
  ggtheme = theme_bw(),
  outlier.tagging = FALSE, # Usuwa warto≈õci odstajƒÖce
  messages = FALSE
) +
  scale_y_log10(limits = c(1000, 1e6)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 16),
    legend.position = "bottom"
  )

dev.off()
```

\###[***5.Wp≈Çyw roku produkcji na cenƒô***]{.underline}

üìåKorelacja Spearmana wynosi 0.77, co potwierdza istotno≈õƒá statystycznƒÖ tej zale≈ºno≈õci üìå Wykres pokazuje silnƒÖ dodatniƒÖ korelacjƒô miƒôdzy rokiem produkcji a cenƒÖ samochodu, co oznacza, ≈ºe nowsze samochody sƒÖ zazwyczaj dro≈ºsze.
üìåZauwa≈ºalna jest pewna rozbie≈ºno≈õƒá punkt√≥w, co sugeruje, ≈ºe na cenƒô wp≈ÇywajƒÖ tak≈ºe inne czynniki, takie jak marka czy stan techniczny.
üìå Histogramy wskazujƒÖ, ≈ºe wiƒôkszo≈õƒá samochod√≥w pochodzi z lat 2010-2020, a ceny wiƒôkszo≈õci pojazd√≥w sƒÖ poni≈ºej 1 miliona PLN.

üìä Wizualizacja: Wykres rozrzutu pokazujƒÖcy wzrost cen wraz z nowszym rokiem produkcji.

```{r, message=FALSE, warning=FALSE}
ggscatterstats(
  data = dane,
  x = year,
  y = price_in_pln,
  title = "Zale≈ºno≈õƒá ceny od roku produkcji samochodu",
  xlab = "Rok produkcji",
  ylab = "Cena (PLN)",
  type = "np",  # Zastosowanie testu Kruskala-Wallisa (non-parametric)
  marginal = TRUE,  # Dodaje histogramy po bokach
  bf.message = FALSE  # Ukrywa Bayes Factor
)
```

###Podsumowanie üì¢ Analiza wykaza≈Ça, ≈ºe: ‚úÖ Rodzaj paliwa, marka oraz rok produkcji znaczƒÖco wp≈ÇywajƒÖ na cenƒô samochodu.
‚úÖ Przebieg ma odwrotny wp≈Çyw ‚Äì im wiƒôkszy, tym ni≈ºsza cena.
‚úÖ Rozk≈Çad cen jest asymetryczny, co wymaga stosowania test√≥w nieparametrycznych.

Wyniki tej analizy mogƒÖ pom√≥c w lepszym zrozumieniu rynku samochodowego i optymalizacji strategii zakupu lub sprzeda≈ºy pojazd√≥w.
üöóüìä ##5 Podsumowanie i wnioski ko≈Ñcowe
